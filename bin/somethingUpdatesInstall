#!/bin/bash source-this-script

SUDO=sudoWithUnixhome; [ $EUID -eq 0 ] && SUDO=''	# Need superuser rights for updating the ignore list.

printUsage()
{
    cat <<HELPTEXT
Offers to update $SOMETHING_SUBJECT_NAME packages that are outdated, and memorizes the
choices for future runs. Exits with 99 if all packages are up-to-date.
HELPTEXT
    echo
    printf 'Usage: %s%q %s\n' "${SUDO}${SUDO:+ }" "$(basename "$1")" '[-?|-h|--help]'
}
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
esac

if [ -n "$SOMETHING_SOURCE_COMMANDLINE" ]; then
    sourceCommandLine="$SOMETHING_SOURCE_COMMANDLINE"
elif type -t "${SOMETHING_SUBJECT}-updates-available" >/dev/null ; then
    sourceCommandLine="${SOMETHING_SUBJECT}-updates-available --terse"
elif type -t "${SOMETHING_SUBJECT}-list-outdated" >/dev/null; then
    sourceCommandLine="${SOMETHING_SUBJECT}-list-outdated | field 1"
else
    echo >&2 'ASSERT: No source command configured; set SOMETHING_SOURCE_COMMANDLINE first.'; exit 3
fi

readarray -t packageNames < <(eval "$sourceCommandLine")
[ ${#packageNames[@]} -eq 0 ] && exit 99

packageNamesPlural=s; [ ${#packageNames[@]} -eq 1 ] && packageNamesPlural=
printf >&2 '%d package%s can be updated.\n' "${#packageNames[@]}" "$packageNamesPlural"


if [ ! $EUID ${SOMETHING_SUPERUSER_COMPAREOP:--eq} 0 ]; then
    echo 'ERROR: Must have superuser rights to update system packages.'
    exit 2
fi

readonly scriptName="$(basename -- "$0")"
askTo()
{
    memoizeDecision --memoize-group "$scriptName" --verb 'is' --state 'outdated' --action 'update it' "$@"
}

typeset -a selectedPackages=()
for packageName in "${packageNames[@]}"
do
    askTo --subject "$packageName" && \
	selectedPackages+=("$packageName")
done

[ ${#selectedPackages[@]} -eq 0 ] && exit 1

${SOMETHING_UPDATE_COMMAND:?} "${selectedPackages[@]}"
